<h1>Deploy do Backend no Render</h1>

<h2>1. O que √© Deploy?</h2>

O verbo **deploy**, em ingl√™s, significa **implantar**.

Em programa√ß√£o, seu sentido est√° intimamente relacionado √† sua tradu√ß√£o literal: fazer um deploy, em termos pr√°ticos, significa colocar na nuvem, ou seja, publicar na Internet alguma aplica√ß√£o que teve seu desenvolvimento conclu√≠do.
Quando um site √© finalizado por uma pessoa desenvolvedora, ele passa pelos √∫ltimos testes e finalmente ele √© hospedado na nuvem atrav√©s do processo chamado deploy.
Do mesmo modo, quando um sistema sofre alguma melhoria ou altera√ß√£o em seu c√≥digo-fonte, implementar essa altera√ß√£o ao sistema que est√° publicado (em Produ√ß√£o), tamb√©m √© chamado de deploy, s√≥ que incremental.

<h2>2. O que veremos por aqui?</h2>

Esse documento √© um passo a passo para voc√™ enviar a sua aplica√ß√£o Nest, gratuitamente para a nuvem. Este processo ir√° gerar um link de acesso a sua aplica√ß√£o, que poder√° ser acessado de qualquer lugar, a partir de qualquer dispositivo com acesso a Internet. 
Para efetuar o Deploy vamos precisar fazer algumas modifica√ß√µes em nosso projeto, que ser√£o detalhadas nos pr√≥ximos t√≥picos.

<h2>üë£ Passo 01 - Criar a Documenta√ß√£o da API</h2>

Para criar a Documenta√ß√£o da API no Swagger, caso voc√™ ainda n√£o tenha criado, utilize o <a href="22.md" target="_blank">**Guia de Configura√ß√£o do Swagger**</a>.

<h2 id="local">üë£Passo 02 - Testar a API no seu computador</h2>

1. Verifique se voc√™ est√° dentro da pasta do projeto, como mostra a figura abaixo:

<div align="center"><img src="https://i.imgur.com/67GK3fX.png" title="source: imgur.com" /></div>

2. Digite o comando ***npm run start:dev***, para compilar e executar o nosso projeto **blogpessoal**, caso n√£o esteja em execu√ß√£o. 

```bash
npm run start:dev
```

3. Abra o Navegador da Internet de sua prefer√™ncia e digite o endere√ßo: **http://localhost:4000/**

6. Verifique se o **Swagger** est√° inicializando automaticamente, como mostra a figura abaixo:

<div align="center"><img src="https://i.imgur.com/JKxWgN5.png?1" title="source: imgur.com" /></div>

5. Teste a sua aplica√ß√£o atrav√©s do **Insomnia** e execute todos os testes para checar se tudo est√° funcionando. 
6. Em especial, verifique se o M√©todo **cadastrar** est√° **criptografando a senha** e se o M√©todo **logar** est√° devolvendo o **Token**.
7. Antes de continuar a configura√ß√£o do projeto para efetuar o Deploy, n√£o esque√ßa de **parar a execu√ß√£o do Projeto no VSCode**.
8. Para finalizar a execu√ß√£o do projeto, utilize as teclas **Ctrl + C** do teclado. Ap√≥s pressionar estas teclas, ser√° exibida a mensagem abaixo perguntando se voc√™ deseja finalizar a aplica√ß√£o.

<div align="center"><img src="https://i.imgur.com/0s6Giqz.png?1" title="source: imgur.com" /></div>

6. Digite **S** para finalizar ou **N** para continuar.


| <img src="https://i.imgur.com/hOgWvSc.png" title="source: imgur.com" width="150px"/> | <p align="justify"> **ATEN√á√ÉO:**  *Lembre-se que antes de fazer o Deploy √© fundamental que a API esteja funcionando e sem erros*. N√£o fa√ßa os testes pelo Swagger, utilize o Insomnia.</p> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

<h2>üë£ Passo 03 - Criar uma conta gr√°tis no Render</h2>

<h3>3.1 O que √© o Render?</h3>



O Render √© uma plataforma unificada para criar e executar todos os seus aplicativos e sites. O Render permite criar e executar todos os seus aplicativos e sites com SSL gratuito, um CDN global, redes privadas e implanta√ß√µes autom√°ticas do Git. 

> Uma **CDN** (Rede de Entrega de Conte√∫do) √© um grupo de servidores geograficamente distribu√≠dos que aceleram a entrega do conte√∫do da Web, aproximando-o de onde os usu√°rios est√£o. 

O Render √© classificado como um **PaaS** (plataforma como servi√ßo), ou seja, √© um conjunto de servi√ßos para criar e gerenciar  aplicativos na nuvem. PaaS fornece os componentes de infraestrutura, que permitem que as pessoas Desenvolvedoras criem, integrem, migrem,   implementem, protejam e gerenciem aplicativos m√≥veis e da web, de forma  simples e r√°pida.

> **Modelos de Servi√ßos na Nuvem:**
>
> - **Plataforma como um servi√ßo (PaaS):** Um provedor de  servi√ßos oferece acesso a um ambiente baseado em cloud no qual os  usu√°rios podem desenvolver e fornecer aplicativos. Al√©m do **Render**, o **Render** e o **Azure** da Microsoft tamb√©m utilizam este modelo.
> - **Infraestrutura como um servi√ßo (IaaS):**  Um provedor de servi√ßos fornece aos clientes acesso Pay As You Go (Pague pelo que  voc√™ usar), para  armazenamento, rede, servidores e outros recursos de  computa√ß√£o na  cloud. O **AWS da Amazon e a Digital Ocean** seguem este modelo.
> - **Software como um servi√ßo (SaaS):** Um provedor de  servi√ßos oferece softwares e aplicativos por meio da  Internet. Os  usu√°rios subscrevem ao software e o acessam por meio da web ou de API's  do fabricante. o **Google Apps e do Microsoft Office 365** seguem este modelo.

Um grande diferencial do Render √© que ele oferece **contas gratu√≠tas**, com algumas limita√ß√µes, que permitem hospedar aplica√ß√µes desenvolvidas em diversas linguagens e **01 Banco de dados PostgreSQL**.

**Principais Limita√ß√µes do Plano Gratuito:**

- Se a aplica√ß√£o ficar **15 minutos sem receber nenhuma requisi√ß√£o**, o aplicativo √© finalizado e ser√° reiniciado somente quando receber outra requisi√ß√£o, para economizar os recursos da plataforma.
- Os servidores do Render est√£o dispon√≠veis apenas na Europa, √Åsia e nos Estados Unidos.
- Os recursos de Mem√≥ria, Disco e Processamento s√£o  limitados, logo a aplica√ß√£o e principalmente o Banco de dados n√£o podem  ser muito grandes.
- Aceita **apenas um Banco de dados por conta**;
- O **tr√°fego mensal √© limitado a 750 horas somando todas as aplica√ß√µes e o Banco de dados**, ou seja, se ultrapassar este valor antes do m√™s acabar, sua conta ficar√° suspensa at√© o m√™s seguinte;
- Dependendo da linguagem, o Deploy da aplica√ß√£o dever√° ser realizado via Docker.

<br />

<div align="left"><img src="https://i.imgur.com/nnCZtX8.png" title="source: imgur.com" width="25px"/> <a href="https://render.com/docs/free" target="_blank"><b>Documenta√ß√£o: Render - Plano Gratu√≠to</b></a></div>

<br />

Vamos criar a conta no Render para fazermos o Deploy:

1) Acesse o endere√ßo: **https://www.render.com**

<div align="center"><img src="https://i.imgur.com/1VVzxQD.png" title="source: imgur.com" width="90%"/></div>

2. Existem diversas formas de criar uma conta no Render. Neste Guia utilizaremos a conta do Github. Clique no link **GitHub**, como mostra a figura abaixo:

<div align="center"><img src="https://i.imgur.com/xfjXrJ8.png" title="source: imgur.com" /></div>

3. Na pr√≥xima janela, digite o endere√ßo do e-mail e a senha da sua conta do Github, e em seguida clique no bot√£o **Sign in**

<div align="center"><img src="https://i.imgur.com/gOhiPeU.png" title="source: imgur.com" /></div>

4. Na pr√≥xima janela, autorize o Render a acessar a sua conta do Github, clicando no bot√£o **Authorize Render**.

<div align="center"><img src="https://i.imgur.com/H3q1w18.png" title="source: imgur.com" /></div>

5. Na pr√≥xima janela, confirme se o endere√ßo do e-mail est√° correto e clique no bot√£o **COMPLETE SIGN UP**

<div align="center"><img src="https://i.imgur.com/AA50W1E.png" title="source: imgur.com" /></div>

6. Na pr√≥xima janela, ser√° exibida uma mensagem solicitando que voc√™ verifique se recebeu uma mensagem no seu e-mail para validar a sua conta no Render. Abra a sua conta de e-mail e verifique se o e-mail foi recebido. Caso n√£o tenha recebido, clique no bot√£o **RESEND VERIFICATION EMAIL**.

<div align="center"><img src="https://i.imgur.com/rZGSHqM.png" title="source: imgur.com" /></div>

7. Abra o e-mail enviado pelo Render (semelhante a imagem abaixo) e **clique no link para validar a sua conta**.

<div align="center"><img src="https://i.imgur.com/wlXD6G8.png" title="source: imgur.com" /></div>

8. Depois de clicar no link, sua conta ser√° validada e ser√° redirecionada para a tela do **Dashboard**.

<div align="center"><img src="https://i.imgur.com/AusmZfX.png" title="source: imgur.com" /></div>

<br />


| <img src="https://i.imgur.com/hOgWvSc.png" title="source: imgur.com" width="100px"/> | <p align="justify"> **ATEN√á√ÉO:**  *Conclua todas etapas do processo de cria√ß√£o da conta no Render antes de avan√ßar para o pr√≥ximo passo do Deploy*. </p> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

<h2>üë£ Passo 04 - Criar o arquivo Procfile</h2>

De volta a aplica√ß√£o, vamos criar o arquivo **Procfile**, na raiz do projeto. Este arquivo tem o objetivo de informar ao Render que o projeto Nest ser√° inicializado na nuvem do Render em modo de produ√ß√£o. Sem este arquivo, o deploy ir√° falhar.

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="220px"/> | <div align="left"> **ALERTA DE BSM:** *Mantenha a Aten√ß√£o aos Detalhes ao criar o arquivo Procfile. Um erro muito comum √© digitar o nome do arquivo de forma incorreta. Observe que o nome do arquivo deve iniciar com letra mai√∫scula, caso contr√°rio o Render n√£o reconhecer√° o arquivo.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

1. Clique com o bot√£o direito do mouse sobre a **ra√≠z do projeto (pasta blogpessoal)**, como mostra a imagem abaixo,  e clique na op√ß√£o **New File** (Novo Arquivo).

<div align="center"><img src="https://i.imgur.com/2xshrmJ.png" title="source: imgur.com" /></div>

2. Observe na imagem acima que n√£o tem nenhuma pasta ou arquivo selecionado. O clique foi efetuado na regi√£o do ponto verde indicado na imagem.
2. O nome do arquivo ser√° **Procfile**, sem nenhuma extens√£o, como mostra a figura abaixo. Ap√≥s digitar o nome do arquivo, pressione a tecla **enter** do seu teclado para concluir. 

<div align="center"><img src="https://i.imgur.com/b8Mnfxk.png" title="source: imgur.com" /></div>

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="100px"/> | <p align="justify"> **ALERTA DE BSM:** *Mantenha a aten√ß√£o aos detalhes ao criar o arquivo Procfile. Um erro muito comum √© n√£o criar o arquivo na pasta raiz do projeto e/ou digitar o nome do arquivo com todas as letras min√∫sculas.* </p> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

4. No arquivo **Procfile** insira a linha abaixo:

```properties
web: npm run start:prod
```

<br />

<div align="left"><img src="https://i.imgur.com/bQGvf3h.png" title="source: imgur.com" width="30px"/> <a href="https://github.com/rafaelq80/backend_blogpessoal_nest/blob/16_Deploy_Heroku/blogpessoal/Procfile" target="_blank"><b>C√≥digo fonte: Procfile</b></a></div>

<br />

<h2>üë£ Passo 05 -Configurar a Classe Main</h2>

Vamos atualizar a **Classe Main**, no arquivo **main.ts**, localizado na pasta **src** do projeto, como mostra a figura abaixo:

<div align="center"><img src="https://i.imgur.com/bKna97v.png" title="source: imgur.com" /></div>

1) Abra a Classe **main.ts**
2) A sua classe estar√° semelhante a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/xexCXUS.png" title="source: imgur.com" /></div>

3. Vamos substituir a **linha 23** (**await app.listen(4000);**), pelo trecho de c√≥digo abaixo:

```javascript
await app.listen(process.env.PORT || 4000);
```

Esta linha permite ao Render atrtibuir qualquer outra porta para a aplica√ß√£o caso a porta 4000 n√£o esteja dispon√≠vel.

<br />

<div align="left"><img src="https://i.imgur.com/bQGvf3h.png" title="source: imgur.com" width="30px"/> <a href="https://github.com/rafaelq80/backend_blogpessoal_nest/blob/16_Deploy_Heroku/blogpessoal/src/main.ts" target="_blank"><b>C√≥digo fonte: Classe Main</b></a></div>

<br />

<h2>üë£ Passo 06 -Configurar o arquivo package.json</h2>

Vamos adicionar algumas linhas no arquivo **package.json**, localizado na pasta raiz do projeto (**blogpesoal**), como mostra a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/hZdi2at.png" title="source: imgur.com" /></div>

1) Abra o arquivo **package.json**
2) Localize a chave **scripts**, no arquivo **package.json**, como mostra a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/AN8SW0n.png" title="source: imgur.com" /></div>

3) Adicione uma virgula na √∫ltima linha da chave **scripts** (**linha 21** na imagem acima), pressione a tecla **enter** do seu teclado para abrir uma nova linha e insira as linhas de c√≥digo abaixo:

```json
"prestart:prod": "npm run build",
"postinstall": "npm run prestart:prod",
"heroku-postbuild": "NODE_ENV=dev npm install --omit --no-shrinkwrap && npm run build"
```
4) Na imagem abaixo, voc√™ confere o final da chave **scripts** com as 3 novas linhas:

<div align="center"><img src="https://i.imgur.com/WXcQj5A.png" title="source: imgur.com" /></div>

Vamos entender estas 3 linhas:

* **prestart:prod:** Define os comandos que ser√£o executados antes de executar a nossa aplica√ß√£o na nuvem. A configura√ß√£o **prestart:prod** define que antes de executar a aplica√ß√£o, vamos gerar o **build da aplica√ß√£o**, ou seja, vamos compilar o c√≥digo e criar a pasta **dist** com todos os arquivos compilados.

* **postinstall:** Define os comandos que ser√£o executados ap√≥s a instala√ß√£o de todos os pacotes Node. Quando o upload do c√≥digo para o servidor do Render √© conclu√≠do, a primeira coisa que o Render far√° √© executar o comando <code>npm install</code> para instalar todos os pacotes. A configura√ß√£o **postinstall** define que ao concluir a instala√ß√£o dos pacotes, vamos executar os comandos da linha **prestart:prod**, ou seja, compilar o c√≥digo.

* **heroku-postbuild:** Define os comandos que ser√£o executados ap√≥s o c√≥digo ser **compilado no Render**.  A configura√ß√£o **heroku-postbuild** define que ao concluir a compila√ß√£o do c√≥digo, vamos executar o **npm install** removendo os pacotes presentes na chave **devDependencies** (Pacotes usados para o Desenvolvimento da aplica√ß√£o), dos arquivos **package.json e package-lock.json** e mantendo apenas os pacotes da chave **dependencies** (Pacotes usados pela aplica√ß√£o em Produ√ß√£o, ou seja na nuvem).


<br />

<div align="left"><img src="https://i.imgur.com/bQGvf3h.png" title="source: imgur.com" width="30px"/> <a href="https://github.com/rafaelq80/backend_blogpessoal_nest/blob/16_Deploy_Heroku/blogpessoal/package.json" target="_blank"><b>C√≥digo fonte: package.json</b></a></div>

<br />

<h2>üë£ Passo 07 - Instalar o Pacote @nestjs/config</h2>

Vamos instalar o Pacote **@nestjs/config** atrav√©s do NPM. Este pacote √© respons√°vel por gerenciar as configura√ß√µes do Nest enviadas atrav√©s das vari√°veis de ambiente. Como iremos configurar uma vari√°vel de ambiente no Render, vamos precisar deste Pacote.

1. Abra o **Terminal** do VSCode atrav√©s do menu **Terminal ü°™ New Terminal**
2. Ser√° aberta janela do **Power Shell** na parte inferior da janela do VSCode.
3. Para instalar o **Pacote @nestjs/config**, digite o comando abaixo:

```bash
npm install --save @nestjs/config
```

4. Ao concluir a instala√ß√£o ser√° exibida a mensagem abaixo:

<div align="center"><img src="https://i.imgur.com/Hkv3ous.png?1" title="source: imgur.com" /></div>

<br />

<h2>üë£ Passo 08 - Instalar o Pacote do PostgreSQL</h2>

O Render, na sua vers√£o gratuita, utiliza o **PostgreSQL** como **SGBD** (Sistema Gerenciador de Bando de dados). 

At√© o momento estamos utilizando o **MySQL** para desenvolver o Blog Pessoal. Ambos s√£o Banco de dados Relacionais e gra√ßas ao **TypeORM**, n√£o ser√° necess√°rio realizar nenhuma altera√ß√£o no c√≥digo da nossa aplica√ß√£o. A √∫nica mudan√ßa necess√°ria, al√©m de instalar **o pacote do PostgreSQL**,  ser√° configurar a conex√£o com o Banco de dados PostgreSQL na nuvem. 

<br />

<div align="left"><img src="https://i.imgur.com/b3khcJI.png" title="source: imgur.com" width="25px"/> <a href="https://www.postgresql.org/" target="_blank"><b>Site Oficial: PostgreSQL</b></a></div>

<br />
	
Vamos instalar o Pacote do PostgreSQL atrav√©s do NPM.

1. Para instalar o **Pacote do PostgreSQL**, digite o comando abaixo:

```bash
npm install --save pg
```

4. Ao concluir a instala√ß√£o ser√° exibida a mensagem abaixo:

<div align="center"><img src="https://i.imgur.com/GlhxRBM.png?1" title="source: imgur.com" /></div>

<br />

<h2>üë£ Passo 09 - Configurar o Banco de Dados na Nuvem</h2>

A Configura√ß√£o do Banco de dados Local √© diferente da configura√ß√£o que ser√° utilizada na Nuvem pelo Render. 

No passo anterior, instalamos a Biblioteca do PostgreSQL, neste passo vamos configurar a aplica√ß√£o para acessar o Banco de dados remoto no Render.

A configura√ß√£o do Banco de dados ser√° implementada na Classe **app.module.ts**, localizado na pasta **src**, como mostra a figura abaixo:

<div align="center"><img src="https://i.imgur.com/sNTEUPJ.png" title="source: imgur.com" /></div>

1) Abra a Classe **app.module.ts**
2) A sua classe estar√° semelhante ao c√≥digo abaixo:

```javascript
import { AppController } from './app.controller';
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { AuthModule } from './auth/auth.module';
import { Postagem } from './postagem/entities/postagem.entity';
import { PostagemModule } from './postagem/postagem.module';
import { Tema } from './tema/entities/tema.entity';
import { TemaModule } from './tema/tema.module';
import { Usuario } from './usuario/entities/usuario.entity';
import { UsuarioModule } from './usuario/usuario.module';

@Module({
  imports: [
    TypeOrmModule.forRoot({
      type: 'mysql',
      host: 'localhost',
      port: 3306,
      username: 'root',
      password: 'root',
      database: 'db_blogpessoal',
      entities: [Postagem, Tema, Usuario],
      synchronize: true,
    }),
    PostagemModule,
    TemaModule,
    UsuarioModule,
    AuthModule
  ],
  controllers: [AppController],
  providers: [],
})
export class AppModule {}
```

3. Primeiro vamos comentar todas as linhas da configura√ß√£o do Banco de dados local (Linhas 14 a 23). **N√£o vamos apagar porqu√™ caso seja necess√°rio atualizar o c√≥digo precisaremos desta configura√ß√£o**. Seu c√≥digo ficar√° semelhante a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/T6fvkFz.png" title="source: imgur.com" /></div>

4. No trecho de c√≥digo abaixo, temos a configura√ß√£o do Banco de dados na nuvem do Render

```javascript
TypeOrmModule.forRoot({
      type: 'postgres',
      url: process.env.DATABASE_URL,
      logging: false,
      dropSchema: false,
      ssl: {
        rejectUnauthorized: false,
      },
      synchronize: true,
      autoLoadEntities: true,
    }),
```

5. Vamos inserir estas linhas logo abaixo da configura√ß√£o local, como mostra a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/psfN8GG.png" title="source: imgur.com" /></div>

A **seta amarela**, indica a **configura√ß√£o local (comentada)** e a **seta verde** indica a **configura√ß√£o remota (habilitada)**.

Vamos detalhar a configura√ß√£o que foi implementada:

**Linha 25:** A propriedade **type** define o tipo do Banco de dados (PostgreSQL).

**Linha 26:** A propriedade **url** define o endere√ßo do servidor, a porta, o usuario, a senha e o nome do banco de dados. Essa url ser√° enviada pelo Render, por isso ela est√° sendo repassada com uma vari√°vel de ambiente.

**Linha 27:** A propriedade **logging** definida como false desabilita a exibi√ß√£o dos erros de SQL no console (Terminal)

**Linha 28:** A propriedade **dropSchema** foi definida como false para impedir que todas as tabelas do Banco de dados sejam apagadas (DROP TABLE) e recriadas todas as vezes que a aplica√ß√£o for reiniciada.

**Linhas 29 e 30:** Configura a seguran√ßa da conex√£o com Banco de dados na nuvem. A propriedade **rejectUnauthorized** foi configurada como **false** para desabilitar o SSL na comunica√ß√£o com o Banco de dados.

> **SSL** √© um certificado digital que autentica a identidade de  um site e possibilita uma conex√£o criptografada. O termo "SSL" significa "Secure Sockets Layer" (camada de soquete seguro), um protocolo de  seguran√ßa que cria um link criptografado entre um servidor Web e um  navegador Web.

**Linha 32:** A propriedade **synchronize** definida como true indica que as tabelas do Banco de dados ser√£o criadas/atualizadas automaticamente em cada inicializa√ß√£o da aplica√ß√£o. Essa cria√ß√£o/atualiza√ß√£o est√° relacionada a estrutura das tabelas e n√£o aos dados.

**Linha 33:** A propriedade **autoLoadEntities** carregar√° todas as Classes Entidades, ou seja, ele procura todas Classes Entidade Registradas na **Classe AppModule** e cria as respectivas tabelas no Banco de dados na nuvem.

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="250px"/> | <p align="justify"> **ALERTA DE BSM:** *Mantenha a aten√ß√£o aos detalhes ao configurar o Banco de Dados na nuvem. Um erro muito comum √© tentar executar o seu projeto no VSCode com a configura√ß√£o do Banco de dados da nuvem. Lembre-se que esta configura√ß√£o s√≥ funciona no Render. Para executar local, comente a configura√ß√£o da Nuvem e descomente a configura√ß√£o Local* </p> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

<div align="left"><img src="https://i.imgur.com/bQGvf3h.png" title="source: imgur.com" width="30px"/> <a href="https://github.com/rafaelq80/backend_blogpessoal_nest/blob/16_Deploy_Heroku/blogpessoal/src/app.module.ts" target="_blank"><b>C√≥digo fonte: Classe AppModule</b></a></div>

<br />

<div align="left"><img src="https://i.imgur.com/bQGvf3h.png" title="source: imgur.com" width="30px"/> <a href="https://github.com/rafaelq80/backend_blogpessoal_nest/tree/16_Deploy_Heroku" target="_blank"><b>C√≥digo fonte: Projeto finalizado</b></a></div>

<br />

<h2>üë£ Passo 10 - Atualizar o reposit√≥rio do projeto no Github</h2>


1. Envie as atualiza√ß√µes do seu projeto para o reposit√≥rio do  Github, atrav√©s do **Git Bash**, utilizando os comandos abaixo:

   ```bash
    git add .
    
    git commit -m ‚ÄúDeploy do Projeto Blog Pessoal‚Äù
    
    git push origin main
   ```
   
| <img src="https://i.imgur.com/hOgWvSc.png" title="source: imgur.com" width="400px"/> | <div align="left"> **ATEN√á√ÉO:** *Para efetuar o Deploy, o projeto Nest OBRIGATORIAMENTE precisa estar em um Reposit√≥rio EXCLUSIVO e n√£o pode estar DENTRO DE UMA PASTA, ou seja, ao abrir o reposit√≥rio do projeto no Github, o conte√∫do exibido ser√° semelhante ao da imagem abaixo. Se estiver diferente da imagem abaixo ser√° necess√°rio refazer o Reposit√≥rio do Github.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<div align="center"><img src="https://i.imgur.com/fX0XW24.png" title="source: imgur.com" /></div>

<br />

<h2>üë£ Passo 11 - Criar o Banco de dados no Render</h2>



1. Para adicionar um novo Banco de dados, no Dashboard do Render, clique no bot√£o **New +** e em seguida clique na op√ß√£o **PostgreSQL**.

<div align="center"><img src="https://i.imgur.com/MbMjaSK.png" title="source: imgur.com" /></div>

<br />

| <img src="https://i.imgur.com/hOgWvSc.png" title="source: imgur.com" width="80px"/> | <p align="justify"> **ATEN√á√ÉO:** O Plano Gratuito do Render autoriza a cria√ß√£o de apenas 1 Banco de dados PostgreSQL por conta. Outro ponto importante √© que me 90 dias o Banco ser√° apagado (Drop Database). </p> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

2. Na pr√≥xima tela, informe o nome do Banco de dados (**db_blogpessoal**), na propriedade **Name**, como mostra a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/0LCVlTo.png" title="source: imgur.com" /></div>

3. Role a tela para baixo e verifique se o Plano Gratuito (**Free**) est√° selecionado e na sequ√™ncia, clique no bot√£o **Create Database**, como mostra a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/fbrL22b.png" title="source: imgur.com" /></div>

<br />

| <img src="https://i.imgur.com/hOgWvSc.png" title="source: imgur.com" width="80px"/> | <p align="justify"> **ATEN√á√ÉO:** *Caso seja selecionado um plano diferente, o Render exigir√° o Cart√£o de Cr√©dito para emitir a fatura do servi√ßo. </p> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

4. Na pr√≥xima tela, aguarde at√© que o **Status** esteja **Available**, como mostra a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/Aq2bsDP.png" title="source: imgur.com" /></div>

5. Role a tela para baixo e localize o item: **External Database URL**, como mostra a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/T9TXAWz.png" title="source: imgur.com" /></div>

6. Clique no bot√£o **copiar**, conforme indicado na imagem abaixo:

<div align="center"><img src="https://i.imgur.com/fLcSTa6.png" title="source: imgur.com" /></div>

7. Abra um arquivo do **Bloco de Notas** e cole esta **URL (Endere√ßo do Banco de dados)** no arquivo, como mostra a imagem abaixo. N√≥s utilizaremos este endere√ßo no pr√≥ximo passo.

<div align="center"><img src="https://i.imgur.com/rQeeJV6.png" title="source: imgur.com" /></div>

<br />

| <img src="https://i.imgur.com/hOgWvSc.png" title="source: imgur.com" width="100px"/> | <p align="justify"> **ATEN√á√ÉO:** *O processo do Deploy enviar√° apenas a sua aplica√ß√£o para a nuvem, logo o Banco de dados que ser√° criado nesta etapa estar√° vazio. </p> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

<h2>üë£ Passo 12 - Criar o Web Service no Render</h2>



1. Na barra de menus principal do Render, clique no item Dashboard, como mostra a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/AYQts2Z.png" title="source: imgur.com" /></div>

2. Para adicionar um novo Web Service, no Dashboard do Render, clique no bot√£o **New +** e em seguida clique na op√ß√£o **Web Service**.

<div align="center"><img src="https://i.imgur.com/FVGlwLN.png" title="source: imgur.com" /></div>

3. No item **GitHub**, clique no link **+ Connect account**, para conectar a sua conta do Render com a sua Conta do Github.

<div align="center"><img src="https://i.imgur.com/xaffIQz.png" title="source: imgur.com" /></div>

4. Na tela, **Install Render**, clique no seu usu√°rio do Github (no exemplo, rafaelproinfo), como mostra a figura abaixo:

<div align="center"><img src="https://i.imgur.com/hfSfPEx.png" title="source: imgur.com" /></div>

5. Na pr√≥xima tela, clique no bot√£o **Install**, para concordar que o Render acesse a sua Conta do Github.

<div align="center"><img src="https://i.imgur.com/Mvp1eX5.png" title="source: imgur.com" /></div>

6. Conecte o Render com o Reposit√≥rio onde voc√™ enviou o **Blog Pessoal**, clicando no bot√£o **Connect**, localizado ao lado do Reposit√≥rio.

<div align="center"><img src="https://i.imgur.com/sBwM5PX.png" title="source: imgur.com" /></div>

7. Na pr√≥xima tela, informe o nome da sua aplica√ß√£o na propriedade **Name** (**blogpessoal**) e verifique se a propriedade **Environment** est√° com a op√ß√£o **Node** selecionada.

<div align="center"><img src="https://i.imgur.com/lXfYSFm.png" title="source: imgur.com" width="90%"/></div>

<br />

| <img src="https://i.imgur.com/hOgWvSc.png" title="source: imgur.com" width="120px"/> | <p align="justify"> **ATEN√á√ÉO:** O NOME DO PROJETO N√ÉO PODE CONTER LETRAS MAIUSCULAS, NUMEROS OU CARACTERES ESPECIAIS. </p> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

8. Role a tela para baixo e verifique se o Plano Gratuito (**Free**) est√° selecionado.

<div align="center"><img src="https://i.imgur.com/ZUU3Et2.png" title="source: imgur.com" /></div>

<br />

| <img src="https://i.imgur.com/hOgWvSc.png" title="source: imgur.com" width="80px"/> | <p align="justify"> **ATEN√á√ÉO:** *Caso seja selecionado um plano diferente, o Render exigir√° o Cart√£o de Cr√©dito para emitir a fatura do servi√ßo. </p> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

<h2>üë£Passo 13 - Configurar as Vari√°veis de Ambiente</h2>



1. Role a tela para baixo e clique no bot√£o **Advanced**, como mostra a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/xBSB5q0.png" title="source: imgur.com" /></div>

2. Na sequ√™ncia, clique no bot√£o **Add Environment Variable**

<div align="center"><img src="https://i.imgur.com/Irh8nio.png" title="source: imgur.com" /></div>

3. No item **Key**, informe o nome da vari√°vel: **DATABASE_URL**

<div align="center"><img src="https://i.imgur.com/imCt0QD.png" title="source: imgur.com" /></div>

4. No arquivo do Bloco de Notas, onde copiamos a URL do Banco de dados, acrescente depois do **.com**, **:5432**, como mostra a imagem abaixo. Este numero √© o numero da porta utilizada pelo PostgreSQL.

<div align="center"><img src="https://i.imgur.com/TJ5IuVe.png" title="source: imgur.com" /></div>

5. Copie o endere√ßo atualizado e cole no item **Value** da Vari√°vel de Ambiente **DATABASE_URL**, como mostra a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/EMhOh4l.png" title="source: imgur.com" /></div>

6. Verifique se a propriedade **Auto-Deploy** est√° com a op√ß√£o **Yes** selecionada

<div align="center"><img src="https://i.imgur.com/QfGb1V0.png" title="source: imgur.com" /></div>

7. Clique no bot√£o **Create Web Service** para criar o Web Service e iniciar o Deploy.

<div align="center"><img src="https://i.imgur.com/3IFof7N.png" title="source: imgur.com" /></div>

8. Acompanhe o processo do Deploy no **Log do Web Service**

<div align="center"><img src="https://i.imgur.com/9Q7bDQf.png" title="source: imgur.com" /></div>

9. Ao finalizar o Deploy, ser√° exibida a mensagem: **Build sucessful** e na sequ√™ncia a aplica√ß√£o ser√° iniciada.

<div align="center"><img src="https://i.imgur.com/Y0QAS8G.png" title="source: imgur.com" /></div>

10. Observe na imagem abaixo, que a mensagem informando que a aplica√ß√£o est√° em execu√ß√£o √© igual a mensagem exibida no Console do VSCode.

<div align="center"><img src="https://i.imgur.com/oK9ZSJt.png" title="source: imgur.com" /></div>

11. Para abrir a aplica√ß√£o no Navegador da Internet, clique no link da aplica√ß√£o, indicado na imagem abaixo:

<div align="center"><img src="https://i.imgur.com/PfuS4aW.png" title="source: imgur.com" /></div>

12. Outra forma de abrir a aplica√ß√£o √© digitando o endere√ßo: **https://nomedoprojeto.onrender.com** no navegador. (No exemplo acima: https://blogpessoal.onrender.com)

<br />

| <img src="https://i.imgur.com/hOgWvSc.png" title="source: imgur.com" width="100px"/> | <p align="justify"> **ATEN√á√ÉO:** Ao clicar no link da aplica√ß√£o, pode acontecer do projeto n√£o abrir automaticamente no navegador. Como o Render precisa finalizar alguns processos, ele pode demorar alguns minutos para abrir o deploy.</p> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="150px"/> | <p align="justify"> **ALERTA DE BSM:** *Mantenha a aten√ß√£o aos detalhes. Caso o nome do projeto j√° seja um endere√ßo em uso no Render, ele acrescentar√° caracteres aleat√≥rios depois do nome do projeto ao criar o endere√ßo da aplica√ß√£o. Exemplo: blogpessoal-wrtc.onrender.com*. </p> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

<h2>‚ùå O Deploy n√£o Abriu!</h2>

Se o **Deploy no Render n√£o abrir** e/ou aparecer a mensagem **Failed**, como mostra a figura abaixo:

<div align="center"><img src="https://i.imgur.com/7SaAc4l.png" title="source: imgur.com" /></div>

- Caso n√£o tenha aparecido mensagens de erro no **Console, na tela Log do Webservice**, clique no bot√£o **Manual Deploy** e em seguida, clique na op√ß√£o **Clear build cache & deploy** para refazer o deploy, como mostra a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/3zTUQrU.png" title="source: imgur.com" /></div>

- Se o erro persistir, verifique se as **Vari√°veis de Ambiente est√£o configuradas corretamente**. Caso seja necess√°rio atualizar o valor de qualquer Vari√°vel de ambiente, o Render iniciar√° um novo Deploy automaticamente ap√≥s a atualiza√ß√£o;

- Caso tenha aparecido algum erro no **Log do Web Service**, identifique o tipo do erro:
  - Se for erro de c√≥digo (erro do Spring), siga as instru√ß√µes do t√≥pico: <a href="#update">**3. Como atualizar o Deploy no Render?**</a> e corrija o erro.
  
- Caso o Deploy exiba a mensagem de conclu√≠do com sucesso, entretanto ao tentar abrir no navegador n√£o aparece nada na tela, experimente trocar o servidor (Region) de hospedagem. O Render possui 4 servidores (Oregon, Ohio, Frankfurt e Singapore), como mostra a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/3roSYWw.png" title="source: imgur.com" /></div>

- Apague o Banco de dados e o WebService, e na sequ√™ncia recrie ambos, alterando servidor. D√™ a prefer√™ncia para os Servidores de Oregon, Ohio e Frankfurt. Lembre-se que Singapore est√° mais distante do Brasil.

<br />

<h2>üë£ Passo 14 - Abrir o Deploy no Navegador</h2>

1. Ao abrir a sua aplica√ß√£o no Navegador, ser√° exibida a tela abaixo:

<div align="center"><img src="https://i.imgur.com/JKxWgN5.png?1" title="source: imgur.com" /></div>

2. Observe que o endere√ßo do deploy ser√° composto pelo **https://nomedoseuprojeto.onrender.com**. No Deploy exemplo, o link ficou: **https://blogpessoal.onrender.com**, como mostra a imagem abaixo. 

<div align="center"><img src="https://i.imgur.com/Bsf7inS.png" title="source: imgur.com" /></div>

| <img src="https://i.imgur.com/hOgWvSc.png" title="source: imgur.com" width="150px"/> | <p align="justify"> **ATEN√á√ÉO:** *O Render tem como pol√≠tica de seguran√ßa o uso OBRIGAT√ìRIO do protocolo https (http com seguran√ßa) nos endere√ßos das aplica√ß√µes hospedadas nos seus servidores.</p> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

Como o Banco de dados criado no Render est√° vazio, precisamos criar uma conta de usu√°rio e efetuar o login com esta conta, obter o token e habilitar o Swagger. 

1. Abra o **Insomnia** e acesse a Workspace **Blog Pessoal**.
2. Crie uma pasta chamada **Blog Pessoal** e arraste as 3 pastas (**Postagem, Tema e Usuario**) para dentro dela.
3. Duplique a pasta **Blog Pessoal** clicando sobre a pasta com o bot√£o direito do mouse e clicando na op√ß√£o **Duplicate** do menu que ser√° aberto.
4. Na pr√≥xima janela, defina o nome da nova pasta como **Blog Pessoal - Render**.

<div align="center"><img src="https://i.imgur.com/hE8xkGA.png" title="source: imgur.com" /></div>

5. Abra a requisi√ß√£o **Cadastrar Usu√°rio** na pasta **Blog Pessoal - Render**.

6. Altere o caminho atual: **http://localhost:4000/usuarios/cadastrar** 

<div align="center"><img src="https://i.imgur.com/mxpZa0m.png" title="source: imgur.com" /></div>

8. Para o endere√ßo do Render: **https://meuprojeto.onrender.com/usuarios/cadastrar** (No exemplo acima: **https://blogpessoal.onrender.com/usuarios/cadastrar**)

<div align="center"><img src="https://i.imgur.com/HmopPqF.png" title="source: imgur.com" /></div>

9. Ap√≥s efetuar as altera√ß√µes, crie o usu√°rio **root@root.com** com os dados da imagem abaixo:

<div align="center"><img src="https://i.imgur.com/3GD5gh1.png" title="source: imgur.com" /></div>

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="150px"/> | <p align="justify"> **ALERTA DE BSM:** *Mantenha a aten√ß√£o aos detalhes. Crie o usu√°rio root exatamente como mostra a figura acima. Ser√° atrav√©s deste usu√°rio que os Instrutores da sua turma ir√£o corrigir o seu projeto*. </p> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

10. Fa√ßa login com este usu√°rio para obter o Token. N√£o esque√ßa de alterar o endere√ßo da Requisi√ß√£o, assim como foi feito na Requisi√ß√£o **Cadastrar Usu√°rio**.

<div align="center"><img src="https://i.imgur.com/GDDxEEK.png" title="source: imgur.com" /></div>

11. Copie apenas a parte codificada do token, ou seja, tudo menos a palavra **Bearer**, como mostra a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/VEL2eiT.png" title="source: imgur.com" /></div>

12. Volte para o Swagger e clique no bot√£o **Authorize**, localizado no lado direito da tela.

<div align="center"><img src="https://i.imgur.com/8YmwsLv.png" title="source: imgur.com" /></div>

13. Cole o token no campo **Value** e clique no bot√£o **Authorize**, como mostra a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/R6onfh2.png" title="source: imgur.com" /></div>

14. Ser√° exibida a mensagem **Authorized** (Autorizado!). Clique no bot√£o **Close**.

<div align="center"><img src="https://i.imgur.com/suHAPUF.png" title="source: imgur.com" /></div>

15. O Swagger est√° desbloqueado e pronto para uso. Observe que os cadeados est√£o todos na cor preta (desbloqueados).

<div align="center"><img src="https://i.imgur.com/RSqkqzk.png" title="source: imgur.com" /></div>

<br />

| <img src="https://i.imgur.com/hOgWvSc.png" title="source: imgur.com" width="100px"/> | <div align="left"> **IMPORTANTE:** O Token est√° configurado para durar 24h, ou seja, daqui a 24h voc√™ ter√° que repetir o processo acima para desbloquear o Swagger novamente.</div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

<h2>üë£ Passo 15 - Testar o Deploy no Insomnia</h2>

1. Volte para o **Insomnia** .
2. Atualize o endere√ßo de todas requisi√ß√µes da pasta **Blog Pessoal - Render**, assim como foi feito nas requisi√ß√µes **Cadastrar Usu√°rio e Login**.
3. Atualize o Token em todas as Requisi√ß√µes, exceto **Cadastrar Usu√°rio e Login**. Lembre-se que o token dura apenas 24 horas!

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="150px"/> | <p align="justify"> **ALERTA DE BSM:** *Mantenha a aten√ß√£o aos detalhes e a persist√™ncia. Insira dados na API atrav√©s do Insomnia em todos os recursos (Postagem, Tema e Usuario). No recurso Postagem, n√£o esque√ßa de testar o Relacionamento entre as 3 Classes*. </p> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<br />

<h2 id="update">3. Como atualizar o Deploy no Render? </h2>

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="100px"/> | <p align="justify"> **ALERTA DE BSM:** *Mantenha a aten√ß√£o aos detalhes. Este item voc√™ utilizar√° apenas se voc√™ precisar alterar alguma coisa no seu projeto Nest e atualizar  a aplica√ß√£o na nuvem*. </p> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

1. Para fazer altera√ß√µes no c√≥digo do projeto e executar localmente, no **VSCode**, abra a **Classe AppModule**, localizada na pasta **src** e **comente as linhas com a configura√ß√£o do Banco de dados na nuvem**. Na sequ√™ncia **retire o coment√°rio das linhas com a configura√ß√£o do Banco de dados Local**, como mostra a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/f388sQb.png" title="source: imgur.com" /></div>

A **seta amarela**, indica a **configura√ß√£o remota (comentada)** e a **seta verde** indica a **configura√ß√£o local (habilitada)**.

2. Fa√ßa as altera√ß√µes necess√°rias no c√≥digo do seu projeto, execute localmente e verifique se est√° tudo funcionando **sem erros**.

3. Antes de refazer o Deploy, altere novamente a configura√ß√£o do Banco de dados, habilitando  a configura√ß√£o na nuvem e desabilitando a configura√ß√£o local, como mostra a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/psfN8GG.png" title="source: imgur.com" /></div>

A **seta amarela**, indica a **configura√ß√£o local (comentada)** e a **seta verde** indica a **configura√ß√£o remota (habilitada)**.

4.  Envie as atualiza√ß√µes do seu projeto para o reposit√≥rio do  Github, atrav√©s do **Git Bash**, utilizando os comandos abaixo: 

```bash
git add .
git commit -m ‚ÄúAtualiza√ß√£o do Deploy - Blog Pessoal‚Äù
git push origin main
```

5. Ao finalizar o **git push**, o Render come√ßar√° a refazer o Deploy. Acompanhe o processo pelo **Dashboard do Render**. 

<div align="center"><img src="https://i.imgur.com/Fj5OmPo.png" title="source: imgur.com" /></div>

6. Verifique se a Aplica√ß√£o abre no Navegador e fa√ßa os testes no Insomnia.

<br /><br />

<div align="left"><a href="README.md"><img src="https://i.imgur.com/XMgF3gl.png" title="source: imgur.com" width="3%"/>Voltar</a></div>
