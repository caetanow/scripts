<h1>Teste de Software - Jest - Configurando o Ambiente</h1>

<h2>üë£ Passo 01 - Instalar o SuperTest</h2>

Vamos instalar a Biblioteca SuperTest atrav√©s do NPM.

1. Abra o **Terminal** do VSCode atrav√©s do menu **Terminal ü°™ New Terminal**
2. Ser√° aberta janela do **Power Shell** na parte inferior da janela do VSCode.
3. Para instalar o **SupeTest**, digite o comando abaixo:

```bash
npm install --save-dev supertest
```

4. Ao concluir a instala√ß√£o ser√° exibida a mensagem abaixo:

<div align="center"><img src="https://i.imgur.com/t5t1DeK.png?1" title="source: imgur.com" /></div>


<h2 >üë£ Passo 02 - Configurar o Banco de dados</h2>

Todos os testes do **M√≥dulo Usuario** ser√£o escritos na Classe de Testes **app.e2e-spec.ts**. A grande vantagem de utilizar esta Classe √© que ela j√° est√° configurada para executar testes a partir do **M√≥dulo App**, ou seja, voc√™ pode escrever testes para qualquer M√≥dulo da aplica√ß√£o sem a necessidade de grandes configura√ß√µes.

1. Vamos abrir a Classe de Testes **app.e2e-spec.ts**, localizada na pasta **test**, como mostra a figura abaixo:

<div align="center"><img src="https://i.imgur.com/yxWtRqG.png" title="source: imgur.com" /></div>

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="150px"/> | <div align="left"> **ALERTA DE BSM:** *Mantenha a Aten√ß√£o aos Detalhes ao escrever os testes da aplica√ß√£o. Observe que a pasta test est√° localizada fora da pasta src.* </div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

2. A Classe de Testes **app.e2e-spec.ts** estar√° implementada com o c√≥digo abaixo:

<div align="center"><img src="https://i.imgur.com/ySg8Iww.png" title="source: imgur.com" /></div>

Vamos fazer algumas altera√ß√µes na Classe:

**Linha 6:** Alterar **'AppController (e2e)'** por **'Testes dos M√≥dulos Usu√°rio e Auth (e2e)'**, para identificar os M√≥dulos que ser√£o testados.

**Linha 9:** Trocar **beforeEach** por **beforeAll**, porqu√™ n√£o precisamos que este M√©todo seja executado antes de cada M√©todo, uma √∫nica vez √© suficiente.

**Linha 18 a 23:** Apagar o **M√©todo / (GET)** inteiro, porqu√™ ele est√° configurado para testar o HelloWorld e n√£o precisaremos mais deste M√©todo.

4. Ap√≥s as altera√ß√µes a nossa Classe de Testes ficar√° semelhante a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/G3t2TzG.png" title="source: imgur.com" /></div>

Na sequ√™ncia, vamos configurar o Banco de dados de teste **db_blogpessoal_test**. Este Banco de dados ser√° criado para evitar que os testes modifiquem os dados do Banco de dados principal da aplica√ß√£o.

1. Abra o **MySQL Workbench**
2. Abra uma nova **Query** e digite o comando abaixo para criar o Banco de dados **db_blogpessoal_test** e execute a query clicando no primeiro raio <img src="https://i.imgur.com/9FtJQlk.png" title="source: imgur.com" width="30px"/>.

```sql
CREATE DATABASE db_blogpessoal_test;
```

3. Ao executar a query, ser√° criado o **Banco de Dados**. Na janela **Navigator**, localizada no lado esquerdo da tela, ser√° exibido o Banco de dados **db_blogpessoal_test** na lista de **Schemas**, como mostra a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/QfLC1b5.png" title="source: imgur.com" width="50%"/></div>

4. Caso o Banco de dados **db_blogpessoal** n√£o esteja aparecendo na lista, clique no bot√£o <img src="https://i.imgur.com/YGV5zIh.png" title="source: imgur.com" width="4%"/> **Refresh**, localizado ao lado direito da palavra **Schemas**, na janela **Navigator**, como mostra a imagem abaixo:

<div align="center"><img src="https://i.imgur.com/kVeQuNX.png" title="source: imgur.com" width="50%"/></div>

Em seguida, vamos configurar a Classe de Testes para utilizar este Banco de dados, atrav√©s do M√©todo **beforeAll()**.


1. Adicione a importa√ß√£o para a Biblioteca **Typeorm** na linha 5, como mostra a imagem abaixo:

   <div align="center"><img src="https://i.imgur.com/BoRqmkA.png" title="source: imgur.com" /></div>

2. Adicione as linhas do trecho de c√≥digo abaixo dentro do array **imports**, na linha 11, **M√©todo beforeAll()**:

```javascript
TypeOrmModule.forRoot({
          type: 'mysql',
          host: 'localhost',
          port: 3306,
          username: 'root',
          password: 'root',
          database: 'db_blogpessoal_test',
          autoLoadEntities: true,
          synchronize: true,
          logging: false,
          dropSchema: true
        }),
```

3. A altera√ß√£o acima est√° destacada na imagem abaixo na cor verde:

<div align="center"><img src="https://i.imgur.com/3tXUjTJ.png" title="source: imgur.com" /></div>

Vamos detalhar o trecho de c√≥digo inserido:

**Linha 13:** Inserimos o M√≥dulo **TypeOrmModule** dentro do array **imports**. Neste M√≥dulo, atrav√©s do M√©todo **forRoot()** iremos configurar a conex√£o com o Banco de dados.

**Linha 14:** A propriedade **type** define o tipo do Banco de dados (MySQL)

**Linha 15:** A propriedade **host** define o endere√ßo do servidor onde Banco de dados est√° hospedado (localhost - seu computador). Caso estivesse na nuvem, seria necess√°rio indicar o endere√ßo na WEB.

**Linha 16:** A propriedade **port** define o numero da porta associada ao Banco de dados (3306 - Porta padr√£o do MySQL)

**Linha 17:** A propriedade **username** define o usu√°rio que utilizaremos para acessar o Banco de dados (root - Usu√°rio administrador do MySQL)

**Linha 18:** A propriedade **password** define a senha do usu√°rio indicado na configura√ß√£o anterior (root - senha padr√£o do MySQL). 

**Linha 19:** A propriedade **database** define o nome do Banco de dados que foi criado no MySQL (db_blogpessoal_test)

**Linha 20:** A propriedade **autoLoadEntities** carregar√° todas as Classes Entidades, ou seja, ele procura todas Classes Entidade Registradas na **Classe AppModule** e cria as respectivas tabelas no Banco de dados **db_blogpessoal_test**.

**Linha 21:** A propriedade **synchronize** definida como true indica que as tabelas do Banco de dados ser√£o criadas/atualizadas automaticamente em cada inicializa√ß√£o da aplica√ß√£o. Essa cria√ß√£o/atualiza√ß√£o est√° relacionada a estrutura das tabelas e n√£o aos dados.

**Linha 22:** A propriedade **logging** definida como false desabilita a exibi√ß√£o dos erros de SQL no console (Terminal)

**Linha 23:** A propriedade **dropSchema** definida como true apaga todas as tabelas do Banco de dados (DROP TABLE) e recria todas as tabelas. Esta propriedade √© √∫til num cen√°rio de testes para manter o ambiente controlado, entretanto n√£o deve ser utilizada em produ√ß√£o, porqu√™ acarretaria na perda de todos os dados do seu cliente toda vez que o sistema fosse reiniciado.


<div align="left"><img src="https://i.imgur.com/O6PILGE.png" title="source: imgur.com" width="25px"/> <a href="https://docs.nestjs.com/modules" target="_blank"><b>Documenta√ß√£o: TypeOrmModule</b></a></div>

<div align="left"><img src="https://i.imgur.com/OtnA0bd.png" title="source: imgur.com" width="30px"/> <a href="https://typeorm.io/data-source-options#mysql--mariadb-data-source-options" target="_blank"><b>Documenta√ß√£o: TypeOrmModule - Op√ß√µes de configura√ß√£o - MySQL</b></a></div>

<br />

Para finalizar, vamos criar o M√©todo **afterAll()**.


1. Acrescente o M√©todo **afterAll()**, trecho de c√≥digo abaixo, depois do M√©todo **beforeAll()**:

```javascript
  afterAll(async () => {
    await app.close();
  });
```

2. A altera√ß√£o acima est√° destacada na imagem abaixo na cor verde:

<div align="center"><img src="https://i.imgur.com/UM4OCNH.png" title="source: imgur.com" /></div>

Vamos entender as altera√ß√µes efetuadas:

O **M√©todo beforeAll()** ser√° executado uma √∫nica vez antes de iniciar os testes. Ele tem como principal responsabilidade criar o M√≥dulo de Testes da aplica√ß√£o (**Test.createTestingModule()**), definindo:

- O Banco de dados que ser√° utilizado durante os testes (**db_blogpessoal_test**), atrav√©s do M√©todo **TypeOrmModule.forRoot()**.

- Os M√≥dulos que ser√£o testados (**AppModule**).

Como a Classe de Testes **app.e2e-specs.ts** est√° configurada para testar o **M√≥dulo AppModule** (M√≥dulo principal da aplica√ß√£o), podemos escrever testes para qualquer M√≥dulo dentro desta Classe de teste.

Ap√≥s criarmos o ambiente, o pr√≥ximo passo √© inicializar o ambiente de testes como uma aplica√ß√£o, atrav√©s do M√©todo **app.init()**, da mesma forma que inicializamos a aplica√ß√£o na **Classe Main**.

O **M√©todo afterAll()**, tem a responsabilidade de finalizar o M√≥dulo de Testes quando todos os testes forem executados e finalizados, atrav√©s do M√©todo **app.close()**.

Abaixo voc√™ confere o c√≥digo da Classe de testes com todas as altera√ß√µes implementadas:

```javascript
import { Test, TestingModule } from '@nestjs/testing';
import { INestApplication } from '@nestjs/common';
import * as request from 'supertest';
import { AppModule } from './../src/app.module';
import { TypeOrmModule } from '@nestjs/typeorm';

describe('Testes dos M√≥dulos Usu√°rio e Auth (e2e)', () => {
  let app: INestApplication;

  beforeEach(async () => {
    const moduleFixture: TestingModule = await Test.createTestingModule({
      imports: [
        TypeOrmModule.forRoot({
          type: 'mysql',
          host: 'localhost',
          port: 3306,
          username: 'root',
          password: 'root',
          database: 'db_blogpessoal_test',
          autoLoadEntities: true,
          synchronize: true,
          logging: false,
          dropSchema: true
        }),
        AppModule],
    }).compile();

    app = moduleFixture.createNestApplication();
    await app.init();
  });

  afterAll(async () => {
    await app.close();
  });
  
});
```

Agora estamos prontos para escrever os nossos M√©todos de teste!	

<div align="left"><a href="README.md"><img src="https://i.imgur.com/XMgF3gl.png" title="source: imgur.com" width="3%"/>Voltar</a></div>
